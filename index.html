
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>人臉打卡系統 (概念展示)</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 載入 face-api.js (改回 cdnjs) -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        /* 確保 canvas 疊在 video 上面 */
        .video-container {
            position: relative;
            width: 640px;
            height: 480px;
        }
        #video, #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        #video {
            object-fit: cover;
        }
        #canvas {
            pointer-events: none; /* 讓 canvas 不會擋住下面的 video */
        }
    </style>
</head>
<body class="bg-gray-100 font-sans leading-normal tracking-normal">

    <div class="container mx-auto max-w-4xl p-8">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">人臉打卡系統 (概念展示)</h1>

        <!-- 狀態訊息 -->
        <div id="statusMessage" class="bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded relative mb-4" role="alert">
            <strong class="font-bold">系統狀態：</strong>
            <span class="block sm:inline">正在加載臉部辨識模型，請稍候...</span>
        </div>

        <div class="flex flex-col lg:flex-row gap-8">
            <!-- 左側：影片與註冊 -->
            <div class="flex-1 bg-white p-6 rounded-lg shadow-lg">
                <h2 class="text-xl font-semibold mb-4 text-center">即時影像</h2>
                <!-- 影片容器 -->
                <div class="video-container mx-auto bg-gray-900 rounded-lg overflow-hidden shadow-inner mb-4">
                    <video id="video" autoplay muted playsinline></video>
                    <canvas id="canvas"></canvas>
                </div>

                <!-- 註冊區 -->
                <div class="space-y-3">
                    <label for="nameInput" class="block text-sm font-medium text-gray-700">輸入姓名進行註冊：</label>
                    <input type="text" id="nameInput" placeholder="例如：王小明" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    <button id="registerButton" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 disabled:bg-gray-400">
                        註冊人臉
                    </button>
                </div>
            </div>

            <!-- 右側：打卡紀錄 -->
            <div class="flex-1 bg-white p-6 rounded-lg shadow-lg">
                <h2 class="text-xl font-semibold mb-4 text-center">打卡紀錄</h2>
                <div id="logContainer" class="h-96 overflow-y-auto bg-gray-50 p-4 rounded-md border border-gray-200">
                    <!-- 紀錄會動態加在這裡 -->
                    <p class="text-gray-500 text-center">尚無打卡紀錄...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const statusMessage = document.getElementById('statusMessage');
        const nameInput = document.getElementById('nameInput');
        const registerButton = document.getElementById('registerButton');
        const logContainer = document.getElementById('logContainer');

        let registeredFaces = []; // 儲存已註冊的人臉
        let checkInLog = new Set(); // 儲存已打卡的人名
        let faceMatcher;

        // 1. 加載模型
        async function loadModels() {
            // 修正：將模型 URL 指向與 face-api.js 腳本一致的 cdn.jsdelivr.net/npm/ 路徑
            const MODEL_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights'; 
            try {
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL),
                    faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL) // 也可以用 SsdMobilenetv1
                ]);
                statusMessage.innerHTML = '<strong class="font-bold">系統狀態：</strong>模型加載完成。正在啟動攝影機...';
                startVideo();
            } catch (error) {
                console.error("模型加載失敗：", error);
                statusMessage.innerHTML = '<strong class="font-bold">系統狀態：</strong>模型加載失敗。請重新整理頁面。';
                statusMessage.classList.remove('bg-blue-100', 'border-blue-400', 'text-blue-700');
                statusMessage.classList.add('bg-red-100', 'border-red-400', 'text-red-700');
            }
        }

        // 2. 啟動攝影機
        async function startVideo() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
                video.srcObject = stream;
                video.addEventListener('play', () => {
                    statusMessage.innerHTML = '<strong class="font-bold">系統狀態：</strong>攝影機已啟動。';
                    statusMessage.classList.remove('bg-blue-100', 'border-blue-400', 'text-blue-700');
                    statusMessage.classList.add('bg-green-100', 'border-green-400', 'text-green-700');
                    
                    // 設置 canvas 尺寸
                    const displaySize = { width: video.clientWidth, height: video.clientHeight };
                    faceapi.matchDimensions(canvas, displaySize);

                    // 啟動人臉辨識循環
                    startRecognitionLoop();
                });
            } catch (err) {
                console.error("無法存取攝影機：", err);
                statusMessage.innerHTML = '<strong class="font-bold">系統狀態：</strong>無法存取攝影機。請檢查權限設定。';
                statusMessage.classList.add('bg-red-100', 'border-red-400', 'text-red-700');
            }
        }

        // 3. 註冊人臉
        registerButton.addEventListener('click', async () => {
            const name = nameInput.value.trim();
            if (!name) {
                alert('請輸入姓名！');
                return;
            }

            statusMessage.innerHTML = `<strong class="font-bold">系統狀態：</strong>正在註冊 ${name}... 請直視鏡頭。`;
            registerButton.disabled = true;

            try {
                // 偵測單一張臉並取得描述符
                const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
                                             .withFaceLandmarks()
                                             .withFaceDescriptor();

                if (!detection) {
                    alert('未偵測到臉部，請確保光線充足並靠近鏡頭。');
                    statusMessage.innerHTML = '<strong class="font-bold">系統狀態：</strong>註冊失敗，未偵測到臉部。';
                    registerButton.disabled = false;
                    return;
                }

                // 儲存描述符
                const descriptor = new faceapi.LabeledFaceDescriptors(name, [detection.descriptor]);
                registeredFaces.push(descriptor);

                // 更新 FaceMatcher
                if (registeredFaces.length > 0) {
                    faceMatcher = new faceapi.FaceMatcher(registeredFaces, 0.6); // 0.6 是辨識的閾值
                }

                statusMessage.innerHTML = `<strong class="font-bold">系統狀態：</strong> ${name} 註冊成功！`;
                nameInput.value = '';
                checkInLog.delete(name); // 允許重新打卡
                
                // 清空打卡紀錄中可能的 "尚無紀錄"
                if (logContainer.innerHTML.includes('尚無打卡紀錄')) {
                    logContainer.innerHTML = '';
                }

                logContainer.innerHTML += `<p class="text-green-600 p-2">【系統】${name} 已註冊成功。</p>`;
                logContainer.scrollTop = logContainer.scrollHeight;


            } catch (error) {
                console.error("註冊失敗：", error);
                statusMessage.innerHTML = '<strong class="font-bold">系統狀態：</strong>註冊時發生錯誤。';
            }
            registerButton.disabled = false;
        });

        // 4. 即時辨識循環
        function startRecognitionLoop() {
            setInterval(async () => {
                if (!video.paused) {
                    const displaySize = { width: video.clientWidth, height: video.clientHeight };
                    faceapi.matchDimensions(canvas, displaySize);

                    // 偵測所有臉部
                    const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
                                                    .withFaceLandmarks()
                                                    .withFaceDescriptors();

                    const resizedDetections = faceapi.resizeResults(detections, displaySize);

                    // 清除畫布
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);

                    if (faceMatcher && resizedDetections.length > 0) {
                        // 進行比對
                        const results = resizedDetections.map(d => faceMatcher.findBestMatch(d.descriptor));

                        results.forEach((result, i) => {
                            const box = resizedDetections[i].detection.box;
                            const drawBox = new faceapi.draw.DrawBox(box, { label: result.toString() });
                            drawBox.draw(canvas);

                            // 如果辨識到且尚未打卡
                            if (result.label !== 'unknown' && !checkInLog.has(result.label)) {
                                logCheckIn(result.label);
                                checkInLog.add(result.label); // 標記為已打卡
                            }
                        });
                    }
                }
            }, 300); // 每 300 毫秒辨識一次
        }

        // 紀錄打卡
        function logCheckIn(name) {
            const now = new Date();
            const timeString = now.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            
            // 清空打卡紀錄中可能的 "尚無紀錄"
            if (logContainer.innerHTML.includes('尚無打卡紀錄')) {
                logContainer.innerHTML = '';
            }

            const logEntry = document.createElement('div');
            logEntry.className = 'p-2 border-b border-gray-200';
            logEntry.innerHTML = `
                <p class="font-semibold text-indigo-700">${name}</p>
                <p class="text-sm text-gray-600">打卡時間：${timeString}</p>
            `;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight; // 自動滾動到底部
        }

        // 啟動程式
        loadModels();
    </script>
</body>
</html>
